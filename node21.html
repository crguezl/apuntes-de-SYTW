<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Introducción</TITLE>
<META NAME="description" CONTENT="Introducción">
<META NAME="keywords" CONTENT="perlexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node22.html">
<LINK REL="previous" HREF="node20.html">
<LINK REL="up" HREF="node20.html">
<LINK REL="next" HREF="node22.html">
</HEAD>

<BODY >

<DIV CLASS="navigation">
<A NAME="tex2html595"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html589"
  HREF="node20.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html583"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html591"
  HREF="node94.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html593"
  HREF="node97.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/~lpp/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="STW"></A><A NAME="tex2html3"
  HREF="http://campusvirtual.ull.es/1213m2/course/view.php?id=245"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="STW moodle"></A><A NAME="tex2html4"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html5"
  HREF="http://rubygems.org/"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html6"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html7"
  HREF="http://github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="google code project hosting"></A><A NAME="tex2html8"
  HREF="https://dl.dropbox.com/u/14539152/STW/STWbook/index.html"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html9"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html10"
  HREF="http://www.ull.es/view/centros/etsii/Grado/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html11"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html12"
  HREF="http://crondinosaur.blogspot.com/"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="pcgull"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html596"
  HREF="node22.html">Streaming y Valores de</A>
<B>Sup:</B> <A NAME="tex2html590"
  HREF="node20.html">Streaming</A>
<B> Ant:</B> <A NAME="tex2html584"
  HREF="node20.html">Streaming</A>
<BR> <P>
</DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><A NAME="tex2html597"
  HREF="node21.html#SECTION01291100000000000000"><TT>Sinatra::Streaming</TT></A>
<LI><A NAME="tex2html598"
  HREF="node21.html#SECTION01291200000000000000">Manteniendo la Conexión Abierta: <TT>keep_open</TT></A>
</UL>
<!--End of Table of Child-Links-->
<HR>

<H2><A NAME="SECTION01291000000000000000">
Introducción</A>
</H2>
En Sinatra 1.3 se introdujo el stream helper. 
El stream object imita a un objeto IO.

<P>
En ocasiones queremos empezar a enviar datos mientras se esta generando aún el cuerpo de la 
respuesta.
Puede que incluso queramos mantener el envío hasta que el cliente cierra la conexión.

<P>
Para eso podemos usar el <code>stream</code> helper:

<P>
<PRE>
get '/' do
  stream do |out|
    out &lt;&lt; "It's gonna be legen -\n"
    sleep 0.5
    out &lt;&lt; " (wait for it) \n"
    sleep 1
    out &lt;&lt; "- dary!\n"
  end
end
</PRE>

<P>
Esto nos permite implementar 

<UL>
<LI>streaming APIs,
</LI>
<LI><A NAME="tex2html20"
  HREF="http://en.wikipedia.org/wiki/Server-sent_events">Server Sent Events</A><A NAME="tex2html18"
  HREF="footnode.html#foot1221"><SUP><SPAN CLASS="arabic">2</SPAN>.<SPAN CLASS="arabic">1</SPAN></SUP></A> 
</LI>
<LI>y que 
puede ser usada como base para <A NAME="tex2html21"
  HREF="http://en.wikipedia.org/wiki/WebSocket">WebSockets</A><A NAME="tex2html19"
  HREF="footnode.html#foot1224"><SUP><SPAN CLASS="arabic">2</SPAN>.<SPAN CLASS="arabic">2</SPAN></SUP></A>.
</LI>
<LI>Puede también ser utilizada para incrementar el throughput si parte pero no todo el contenido depende
de un recurso que es lento.
</LI>
</UL>

<P>
Nótese que la conducta de streaming, en particular
el número de solicitudes concurrentes, 
depende en gran medida del servidor web
que sirve la aplicación.

<P>

<UL>
<LI>Algunos servidores como <A NAME="tex2html22"
  HREF="http://naupacto.com/rubydoc/guiaWEBrick/index.html"><TT>Webrick</TT></A> no soportan streaming. En tal caso el cuerpo es 
envíado en una tacada.
</LI>
<LI><A NAME="tex2html23"
  HREF="http://ruby.about.com/od/sinatra/a/sinatra5.htm"><TT>Shotgun</TT></A> tampoco soporta streaming
</LI>
</UL>

<P>

<H3><A NAME="SECTION01291100000000000000">
<TT>Sinatra::Streaming</TT></A>
</H3>
Sinatra 1.3 introduced the stream helper. The addon provided by the gem
<code>sinatra-contrib</code> improves the
streaming API by making the stream object immitate an <code>IO</code> object,
making the body play nicer
with middleware unaware of streaming.

<P>
This is useful when passing the stream object to a library expecting an IO or StringIO object.

<P>
<PRE>
06:31][~/srcSTW/streaming/upandrunning_streaming]$ cat -n simple.rb 
     1  # http://www.sinatrarb.com/contrib/streaming.html
     2  # $ gem install sinatra-contrib
     3  require 'sinatra'
     4  require 'sinatra/streaming'
     5  set server: 'thin'
     6  #set server: 'unicorn'
     7  
     8  get '/' do
     9    stream do |out|
    10      puts out.methods
    11      out.puts "Hello World!", "How are you?"
    12      out.write "Written #{out.pos} bytes so far!\n"
    13      out.putc(65) unless out.closed?
    14      out.flush
    15    end
    16  end
</PRE>

<P>

<H3><A NAME="SECTION01291200000000000000">
Manteniendo la Conexión Abierta: <TT>keep_open</TT></A>
</H3>

<P>

<UL>
<LI>Si el parámetro opcional se pone a <code>keep_open</code>, 
<code>close</code> no será llamado al finalizar el bloque,
permitiendo su cierre en un punto posterior del flujo de 
ejecución.

<P>
</LI>
<LI>Esto sólo funciona en  <A NAME="1463"></A><SPAN  CLASS="textit">evented servers</SPAN><A NAME="tex2html24"
  HREF="footnode.html#foot1236"><SUP><SPAN CLASS="arabic">2</SPAN>.<SPAN CLASS="arabic">3</SPAN></SUP></A>, 
como Thin y Rainbows. Otros servidores cerrarán el stream:
</LI>
</UL>

<P>
<PRE>
[07:15][~/sinatra/sinatraupandrunning/chapter2/streaming(master)]$ cat -n keep_open.rb 
     1  require 'sinatra'
     2  
     3  set :server, :thin
     4  set :connections, []
     5  
     6  before do
     7   content_type :txt
     8  end
     9  
    10  get '/' do
    11    # keep stream open
    12    stream(:keep_open) do |out| 
    13      puts out.inspect
    14      puts out.class
    15      puts out.instance_variables
    16      puts out.class.class_variables
    17      puts out.methods(false)
    18      settings.connections &lt;&lt; out 
    19    end
    20  end
    21  
    22  get '/b/:message' do |b|
    23    # write to all open streams
    24    settings.connections.each do |out| 
    25      out &lt;&lt; b 
    26     end
    27    "message '#{b}' sent"
    28  end
</PRE>
Cuando se ejecuta nos informa sobre el objeto <code>out</code>:
<PRE>
[06:47][~/sinatra/sinatraupandrunning/chapter2/streaming(master)]$ ruby keep_open.rb 
== Sinatra/1.3.3 has taken the stage on 4567 for development with backup from Thin
&gt;&gt; Thin web server (v1.3.1 codename Triple Espresso)
&gt;&gt; Maximum connections set to 1024
&gt;&gt; Listening on 0.0.0.0:4567, CTRL+C to stop
#&lt;Sinatra::Helpers::Stream:0x007f9b78d09ee8 @keep_open=:keep_open,
   @scheduler=EventMachine,
   @back=#&lt;Proc:0x007f9b78d09e48@/usr/local/rvm/gems/ruby-1.9.2-p290/gems/sinatra-1.3.3/lib/sinatra/base.rb:345&gt;,
   @callbacks=[#&lt;Proc:0x007f9b78c4ab88@/usr/local/rvm/gems/ruby-1.9.2-p290/gems/thin-1.3.1/lib/thin/connection.rb:114&gt;,
   #&lt;Proc:0x007f9b78c4ab10@/usr/local/rvm/gems/ruby-1.9.2-p290/gems/thin-1.3.1/lib/thin/connection.rb:115&gt;],
   @closed=false,
   @front=#&lt;Proc:0x007f9b78c4adb8@/usr/local/rvm/gems/ruby-1.9.2-p290/gems/thin-1.3.1/lib/thin/response.rb:88&gt;
&gt;
Sinatra::Helpers::Stream
@keep_open
@scheduler
@back
@callbacks
@closed
@front
^C&gt;&gt; Stopping ...

== Sinatra has ended his set (crowd applauds)
127.0.0.1 - - [15/Nov/2012 06:49:51] "GET / HTTP/1.1" 200 - 30.7024
</PRE>
Vemos que los objetos <code>out</code> están en la clase
<A NAME="tex2html26"
  HREF="http://rubydoc.info/github/sinatra/sinatra/Sinatra/Helpers/Stream">Sinatra::Helpers::Stream</A>.

<P>
El siguiente ejemplo elabora el anterior y muestra como mantener una conexión persitente, abierta para enviar
mensajes de broadcast a unos suscriptores:

<P>
<PRE>
casiano@nereida:~/srcSTW/streaming/upandrunning_streaming$ cat -n a_simple_straming_example.rb 
 1  # coding: utf-8
 2  # page 46. Example 2-37.
 3  require 'sinatra'
 4
 5  before do
 6    content_type :txt
 7  end
 8
 9  set server: 'thin', connections: []
10
11  get '/consume' do
12    stream(:keep_open) do |out|
13      # store connection for later on
14      settings.connections &lt;&lt; out
15
16      # remove connection when closed properly
17      out.callback { settings.connections.delete(out) }
18
19      # remove connection when due to an error
20      out.errback do
21        logger.warn 'we just lost the connection!'
22        settings.connections.delete(out)
23      end
24
25    end # stream
26  end
27
28
29  get '/broadcast/:message' do
30    settings.connections.each do |out|
31      out &lt;&lt; "#{Time.now} -&gt; #{params[:message]}" &lt;&lt; "\n"
32    end
33
34    "Sent #{params[:message]} to all clients."
35  end
</PRE>

<P>
Para usar este ejemplo 
arrancamos el programa. Obsérvese que el servidor usado es <code>thin</code>.
Después visitamos con uno o mas navegadores la página 
<code>localhost:4567/consume</code>. El navegador queda a la espera del
servidor que ejecuta el bloque en las líneas 12-25.
la página
que será enviada en streaming.
En una terminal usando <code>curl</code> nos conectamos a la URL
<code>http://localhost:4567/broadcast/choco</code>. Esto hace que se ejecute
el bloque de las líneas 30-31 y que un mensaje con el formato <code>fecha -&gt; choco</code> 
se envíe al objeto stream
<code>out</code>. En el navegador aparecerá el mensaje <code>Sent choco to all clients</code>.

<P>

<DIV ALIGN="CENTER"><A NAME="figure:broadcaststreaming"></A><A NAME="1251"></A>
<TABLE>
<CAPTION ALIGN="BOTTOM"><STRONG>Figura:</STRONG>
Manteniendo una Conexión Abierta</CAPTION>
<TR><TD>
<DIV ALIGN="CENTER">
<IMG
  WIDTH="864" HEIGHT="540" ALIGN="BOTTOM" BORDER="0"
 SRC="./streamingbroadcast.png"
 ALT="Image streamingbroadcast">

</DIV></TD></TR>
</TABLE>
</DIV>

<P>

<DIV CLASS="navigation"><HR>
<A NAME="tex2html595"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html589"
  HREF="node20.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html583"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html591"
  HREF="node94.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html593"
  HREF="node97.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/~lpp/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="STW"></A><A NAME="tex2html3"
  HREF="http://campusvirtual.ull.es/1213m2/course/view.php?id=245"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="STW moodle"></A><A NAME="tex2html4"
  HREF="perlexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="pdf"></A><A NAME="tex2html5"
  HREF="http://rubygems.org/"><IMG
  WIDTH="60" ALIGN="BOTTOM" BORDER="0"
 SRC="lupa.gif"
 ALT="ruby gems"></A><A NAME="tex2html6"
  HREF="http://www.ruby-doc.org/"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="perlonion.jpeg"
 ALT="perldoc"></A><A NAME="tex2html7"
  HREF="http://github.com"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="google-code-project-hosting.jpeg"
 ALT="google code project hosting"></A><A NAME="tex2html8"
  HREF="https://dl.dropbox.com/u/14539152/STW/STWbook/index.html"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="blogs"></A><A NAME="tex2html9"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html10"
  HREF="http://www.ull.es/view/centros/etsii/Grado/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html11"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html12"
  HREF="http://crondinosaur.blogspot.com/"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="pcgull"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html596"
  HREF="node22.html">Streaming y Valores de</A>
<B>Sup:</B> <A NAME="tex2html590"
  HREF="node20.html">Streaming</A>
<B> Ant:</B> <A NAME="tex2html584"
  HREF="node20.html">Streaming</A>
</DIV>
<!--End of Navigation Panel-->
<ADDRESS>
<I>Casiano Rodríguez León <BR>
2013-04-24</I>
</ADDRESS>
</BODY>
</HTML>
